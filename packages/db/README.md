# @kianax/db

Shared database package using Drizzle ORM with PostgreSQL.

## Setup

1. **Install dependencies** (from root):
   ```bash
   bun install
   ```

2. **Configure environment**:
   ```bash
   cp .env.example .env
   # Edit .env with your database credentials
   ```

3. **Run PostgreSQL** (using Docker):
   ```bash
   docker run -d \
     --name kianax-postgres \
     -e POSTGRES_PASSWORD=postgres \
     -e POSTGRES_DB=kianax \
     -p 5432:5432 \
     postgres:16
   ```

## Usage

### In your application

```typescript
import { db, users, eq } from '@kianax/db';

// Query users
const allUsers = await db.select().from(users);

// Filter by user_id
const user = await db
  .select()
  .from(users)
  .where(eq(users.id, userId))
  .limit(1);
```

### Database Commands

```bash
# Generate migrations from schema changes
bun run db:generate

# Apply migrations to database
bun run db:migrate

# Push schema directly (dev only, skips migrations)
bun run db:push

# Open Drizzle Studio (database GUI)
bun run db:studio
```

## Schema Reference

See `src/schema/todo.ts` for examples of:
- Table definitions
- Column types
- Enums
- Foreign keys
- JSONB fields
- Type inference

## Adding New Tables

1. Create new schema file in `src/schema/`:
   ```typescript
   // src/schema/orders.ts
   import { pgTable, uuid, varchar } from 'drizzle-orm/pg-core';

   export const orders = pgTable('orders', {
     id: uuid('id').primaryKey().defaultRandom(),
     user_id: uuid('user_id').notNull(),
     // ... more columns
   });
   ```

2. Export from `src/schema/index.ts`:
   ```typescript
   export * from './orders';
   ```

3. Generate migration:
   ```bash
   bun run db:generate
   ```

4. Apply migration:
   ```bash
   bun run db:migrate
   ```

## Multi-Tenant Pattern

**Always filter by `user_id`** to ensure data isolation:

```typescript
// ❌ BAD - Returns all users' data
const agents = await db.select().from(agents);

// ✅ GOOD - Returns only authenticated user's data
const agents = await db
  .select()
  .from(agents)
  .where(eq(agents.user_id, req.user.id));
```

## Project Structure

```
packages/db/
├── src/
│   ├── schema/
│   │   ├── users.ts       # Users table
│   │   ├── todo.ts        # Reference/example
│   │   └── index.ts       # Export all schemas
│   ├── migrations/        # Generated by drizzle-kit
│   ├── client.ts          # Database client
│   └── index.ts           # Package exports
├── drizzle.config.ts      # Drizzle configuration
└── package.json
```
