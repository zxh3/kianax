# Local Development

Simple setup for developing Kianax locally with Convex.

## Prerequisites

- Node.js 18+ or Bun 1.2+
- Text editor (VS Code recommended)

## First-Time Setup

```bash
# Clone and install
git clone <your-repo>
cd kianax
bun install

# Initialize Convex (creates project + generates files)
npx convex dev
# Follow prompts to create Convex account (free)
# This creates convex/ directory and .env.local automatically
```

**That's it.** No Docker, databases, or configuration needed.

## Daily Development

```bash
# Terminal 1: Convex backend
npx convex dev

# Terminal 2: Next.js frontend
bun run dev

# Open browser
open http://localhost:3000
```

**Convex dev provides:**
- Local dev server with hot reload
- Real-time database with TypeScript schema
- Function execution and logs
- Dashboard at https://dashboard.convex.dev

## Development Workflow

### 1. Define Schema

```typescript
// convex/schema.ts
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  workflows: defineTable({
    userId: v.string(),
    name: v.string(),
    type: v.union(v.literal("root"), v.literal("sub-workflow")),
    nodes: v.array(v.any()),
    edges: v.array(v.any()),
  }).index("by_user", ["userId"]),
});
```

Schema changes are **instant** - no migrations needed.

### 2. Write Functions

```typescript
// convex/workflows.ts
import { query, mutation } from "./_generated/server";
import { v } from "convex/values";

// Query (read) - auto-subscribes in React
export const list = query({
  handler: async (ctx) => {
    const userId = (await ctx.auth.getUserIdentity())?.subject;
    return await ctx.db.query("workflows")
      .withIndex("by_user", q => q.eq("userId", userId))
      .collect();
  },
});

// Mutation (write)
export const create = mutation({
  args: { name: v.string(), nodes: v.array(v.any()) },
  handler: async (ctx, args) => {
    const userId = (await ctx.auth.getUserIdentity())?.subject;
    return await ctx.db.insert("workflows", {
      userId,
      ...args,
    });
  },
});
```

### 3. Use in Frontend

```typescript
// app/workflows/page.tsx
"use client";
import { useQuery, useMutation } from "convex/react";
import { api } from "@/convex/_generated/api";

export default function WorkflowsPage() {
  const workflows = useQuery(api.workflows.list);
  const createWorkflow = useMutation(api.workflows.create);

  // Real-time! Auto-updates when data changes
  return (
    <div>
      {workflows?.map(w => <div key={w._id}>{w.name}</div>)}
      <button onClick={() => createWorkflow({ name: "Test", nodes: [] })}>
        Create
      </button>
    </div>
  );
}
```

## Testing Functions

### From CLI

```bash
# Run a query
npx convex run workflows:list

# Run a mutation
npx convex run workflows:create '{"name": "Test", "nodes": []}'

# Tail logs
npx convex dev --tail-logs
```

### From Dashboard

1. Open https://dashboard.convex.dev
2. Go to your project
3. Click "Functions" tab
4. Select function and click "Run"

## Environment Variables

```env
# .env.local (auto-generated by convex dev)
CONVEX_DEPLOYMENT=dev:your-project-name
NEXT_PUBLIC_CONVEX_URL=https://...

# Add your own
OPENAI_API_KEY=sk-...
TRIGGER_DEV_API_KEY=...
```

**Convex secrets** (for backend):
```bash
npx convex env set OPENAI_API_KEY sk-...
```

## Common Tasks

### Add New Table

1. Edit `convex/schema.ts`
2. Save (Convex auto-deploys)
3. Use immediately in functions

### Debug Function

1. Add `console.log()` in function
2. Check terminal running `npx convex dev`
3. Or check Dashboard logs

### Reset Database

```bash
npx convex import --clear  # Clears all data
```

**Warning:** This deletes everything in development!

### Test Real-Time Updates

1. Open app in two browser tabs
2. Create workflow in tab 1
3. Watch it appear instantly in tab 2

No polling. No manual WebSockets. Just works.

## Tips

**Type Safety:**
- Convex auto-generates TypeScript types from schema
- `api.workflows.list` is fully typed
- Errors caught at compile time

**Performance:**
- Convex caches query results automatically
- Frontend only re-renders on actual changes
- No need for manual cache management

**Debugging:**
- Check `npx convex dev` logs for function errors
- Use Dashboard for inspecting database
- Browser DevTools shows Convex WebSocket (automatic)

## Deploy to Production

```bash
# Deploy Convex backend
npx convex deploy

# Deploy Next.js frontend
vercel deploy

# That's it!
```

Production uses same Convex code, different deployment.

---

**Questions?**
- [Convex Docs](https://docs.convex.dev)
- [trigger.dev Docs](https://trigger.dev/docs)
- Check `convex/README.md` for project-specific notes
